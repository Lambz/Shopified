<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background-color: rgb(241, 244, 249);
        }

        .overlay {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            background-color: rgba(92, 95, 236, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .buy-btn {
            border: none;
            display: flex;
            width: 60px;
            height: 60px;
            justify-content: center;
            align-items: center;
            background-color: white;
            /* background: white url(media/trash.png);
            background-position: 8px 8px;
            background-repeat: no-repeat; */
            color: #252525;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 20px;
            box-shadow: 2px 2px 30px rgba(0, 0, 0, 0.2);
        }

        .buy-btn:hover {
            color: white;
            background-color: #f15fa3;
            transition: all ease 0.3;
        }

        .buy-btn:hover .trash-btn {
            filter: brightness(0) invert(1);
            cursor: pointer;
        }

        .overlay {
            visibility: hidden;
        }

        .product-image:hover .overlay {
            visibility: visible;
            animation: fade 0.5s;
        }

        @keyframes fade {

            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }

        }
    </style>
    <title>Products</title>
</head>

<body>
    <header class="header">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="dashboard.html">Shopified</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="products.html">Products<span
                                class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <!-- <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Dropdown
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">Disabled</a>
                    </li> -->
                </ul>
                <form class="form-inline my-2 my-lg-0">
                    <!-- <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search"> -->
                    <button class="btn btn-outline-success my-2 my-sm-0" onclick="signOut()">Sign Out</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container mt-2">
        <div class="jumbotron">
            <div class="card">
                <div class="card-header container-fluid">
                    <!-- Products -->
                    <div class="row">
                        <div class="col-md-10">
                            <h4 class="w-75 p-1" id="title">Add Products</h4>
                        </div>
                        <div class="col-md-2 p-1 float-right">
                            <button onclick="selectImages()" class="btn btn-primary">Add Images</button>
                            <input id='file-input' type='file' style="display: none;"
                                accept="image/x-png,image/gif,image/jpeg" multiple />
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="carouselExampleControls" class="carousel slide mb-3" data-ride="carousel">
                        <div id="coursel-inner" class="carousel-inner">
                            <div class="carousel-item active">
                                <div class="row">
                                    <div class="col-3 product-image">
                                        <img class="d-block w-100" src="media/product_placeholder.gif"
                                            alt="Product Placeholder">
                                        <!-- <div class="overlay">
                                            <button onclick="removeImage(0)" class="buy-btn">Test</button>
                                        </div> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a class="carousel-control-prev" href="#carouselExampleControls" role="button"
                            data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carouselExampleControls" role="button"
                            data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <label for="pName">Product Name:</label>
                    <input type="text" name="pName" id="pName" class="form-control mb-3"
                        placeholder="Name of the Product" />
                    <label for="categories">Category:</label>
                    <select class="custom-select custom-select-sm mb-3" name="categories" id="categories">

                    </select>
                    <label for="subCategories">Sub-Category:</label>
                    <select class="custom-select custom-select-sm mb-3" name="subCategories" id="subCategories">

                    </select>
                    <label for="pPrice">Price:</label>
                    <!-- <input type="number" name="pPrice" id="pPrice" class="form-control mb-3" placeholder="Price"/> -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">$</span>
                        </div>
                        <input type="number" id="pPrice" name="pPrice" placeholder="0" class="form-control"
                            aria-label="Amount">
                    </div>
                    <label for="pQuantity">Quanitity:</label>
                    <input type="number" name="pQuantity" id="pQuantity" class="form-control mb-3" placeholder="1000" />
                    <label for="pDescription">Description: </label>
                    <textarea id="pDescription" name="pDescription" class="form-control mb-3"
                        aria-label="With textarea"></textarea>
                    <label for="pTime">Estimated Shipping Time:</label>
                    <div class="input-group mb-3">
                        <input type="number" id="pTime" name="pTime" class="form-control" placeholder="1" aria-label="1"
                            aria-describedby="basic-addon2">
                        <div class="input-group-append">
                            <span class="input-group-text" id="basic-addon2">Day</span>
                        </div>
                    </div>
                    <button type="button" id="addProductBtn" onclick="addProduct(true)"
                        class="btn btn-primary btn-lg btn-block">Add
                        Product</button>
                    <br />
                    <button type="button" id="deleteProductBtn" onclick="deleteP()" style="display: none;"
                        class="btn btn-danger btn-lg btn-block">Delete
                        Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="scripts/main.js"></script> -->
    <!-- <script src="../scripts/Utilties.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="js/bootstrap.js"></script> -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"></script>
    <script src="../scripts/Utilties.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-storage.js"></script>
    <!-- <script src="scripts/main.js"></script> -->
    <script src="../scripts/models.js"></script>
    <script src="../scripts/firebaseHandlers.js"></script>
    <script src="../scripts/interface.js"></script>
    <script>

        const id = new URL(window.location.href).searchParams.get("id");
        const categories = document.getElementById("categories");
        const subCategories = document.getElementById("subCategories");
        const nameInput = document.getElementById("pName");
        const categoriesInput = document.getElementById("categories");
        const subCategoriesInput = document.getElementById("subCategories");
        const priceInput = document.getElementById("pPrice");
        const quanitityInput = document.getElementById("pQuantity");
        const descriptionInput = document.getElementById("pDescription");
        const timeInput = document.getElementById("pTime");
        const addProductBtn = document.getElementById("addProductBtn");
        const deleteProductBtn = document.getElementById("deleteProductBtn");
        let product = null;
        window.onload = function () {
            getUserDetails(false,(seller) => {
                if(seller == codes.NOT_FOUND)
                {
                    window.location.replace("index.html");
                }
            });
            fetchAllCategoriesAndSubcategories(categoryCallBack);
        }

        function categoryCallBack(result) {
            // console.log(result);
            categories.addEventListener("change", function () {
                if (categories.value != "New Category") {
                    subCategories.innerHTML = "";
                    result.forEach((category) => {
                        if (category.name == categories.value) {
                            category.subcategories.forEach((subCategory) => {
                                subCategories.innerHTML += `<option value="${subCategory}">${subCategory}</option>`;
                            });
                        }
                    });
                    let opt = document.createElement("option");
                    opt.value = "New Sub-Category";
                    opt.text = "New Sub-Category";
                    subCategories.add(opt);
                }
                else {
                    let categoryVal = prompt("Please enter new category name", "");
                    if (categoryVal != null && categoryVal != "") {
                        let opt = document.createElement("option");
                        opt.value = categoryVal;
                        opt.text = categoryVal;
                        categories.add(opt);
                        let subCategoryVal = prompt("Please enter new sub category name", "");
                        if (subCategoryVal == null || subCategoryVal == "") {
                            categories.remove(categories.length - 1);
                            categories.selectedIndex = 0;
                        }
                        else {
                            subCategories.innerHTML = "";
                            let opt = document.createElement("option");
                            opt.value = subCategoryVal;
                            opt.text = subCategoryVal;
                            subCategories.add(opt);
                            categories.value = categoryVal;
                            opt = document.createElement("option");
                            opt.value = "New Sub-Category";
                            opt.text = "New Sub-Category";
                            subCategories.add(opt);
                        }
                    }
                    else {
                        categories.selectedIndex = 0;
                    }

                }

            });
            if (result != null && result.length > 0) {
                result.forEach((category) => {
                    // categories.innerHTML += `<option value="${category.name}">${category.name}</option>`;
                    var opt = document.createElement("option");
                    opt.value = category.name;
                    opt.text = category.name;
                    categories.add(opt);
                });
                result[0].subcategories.forEach((subCategory) => {
                    subCategories.innerHTML += `<option value="${subCategory}">${subCategory}</option>`;
                });
                let opt = document.createElement("option");
                opt.value = "New Category";
                opt.text = "New Category";
                categories.add(opt);
                if (id != null) {
                    getUserDetails(false, getProduct);
                }
            }
        }

        let images = [];
        function selectImages() {
            let fileInput = document.getElementById("file-input");
            fileInput.click();
            let listener = fileInput.addEventListener('change', fileEventListener, true);

            function fileEventListener(evnt) {
                for (var i = 0; i < fileInput.files.length; i++) {
                    // fileList.push(fileInput.files[i]);
                    // console.log(fileInput.files.length);
                    images.push(fileInput.files[i]);
                    // console.log(images);
                }
                fileInput.removeEventListener('change', fileEventListener, true);
                // renderFileList();s
                updateCarousel();
            }
        }

        function updateCarousel() {
            // console.log(images.length);
            let slides = Math.ceil(images.length / 4);
            let courselInner = document.getElementById("coursel-inner");
            let inner = "";
            // console.log(URL.createObjectURL(images[0]));
            // console.log(images);
            for (let i = 0; i < slides; i++) {
                if (i == 0) {
                    inner += `<div class="carousel-item active"><div class="row">`;
                }
                else {
                    inner += `<div class="carousel-item"><div class="row">`;
                }
                for (let j = i * 4; j < (i + 1) * 4 && j < images.length; j++) {
                    // console.log(`i:${i} j:${j}`)
                    console.log(typeof (images[j]));
                    let src;
                    if (typeof (images[j]) == "object") {
                        src = URL.createObjectURL(images[j]);
                    }
                    else {
                        src = images[j];
                    }
                    inner += `<div class="col-3 product-image"><img class="d-block w-100" src="${src}" alt="Product Image"><div class="overlay"><button onclick="removeImage(${j})" class="buy-btn"><img src="media/trash.png" class="trash-btn" style="width:40px; height:40px" /></button></div></div>`
                }
                inner += "</div></div>";
            }
            // console.log(inner);
            courselInner.innerHTML = inner;
            // console.log(slides);
        }

        function removeImage(index) {
            images.splice(index, 1);
            updateCarousel();
        }

        function addProduct(newProduct = false) {
            console.log(newProduct);
            let noProb = true;
            let name = nameInput.value;
            let category = categoriesInput.value;
            let subCategory = subCategoriesInput.value;
            let price = priceInput.value;
            let quantity = quanitityInput.value;
            let description = descriptionInput.value;
            let time = timeInput.value;
            if (name == "") {
                nameInput.style.border = "1px solid red";
                noProb = false;
            }
            if (category == "") {
                categoriesInput.style.border = "1px solid red";
                noProb = false;
            }
            if (subCategory == "") {
                subCategoriesInput.style.border = "1px solid red";
                noProb = false;
            }
            if (price == "") {
                priceInput.style.border = "1px solid red";
                noProb = false;
            }
            if (quantity == "") {
                quanitityInput.style.border = "1px solid red";
                noProb = false;
            }
            if (description == "") {
                descriptionInput.style.border = "1px solid red";
                noProb = false;
            }
            if (time == "") {
                timeInput.style.border = "1px solid red";
                noProb = false;
            }
            if (noProb) {
                getUserDetails(false, function (seller) {
                    console.log(seller)
                    let uid = sessionStorage.getItem("uid");
                    let p;
                    if (newProduct) {
                        console.log("if");
                        p = new Product(name, generateID(30), category, subCategory, price, seller.company, uid, time, [], quantity, description);
                    }
                    else {
                        console.log("else");
                        p = product;
                        p.name = name;
                        p.category = category;
                        p.subcategory = subCategory;
                        p.price = price;
                        p.seller = seller.company;
                        p.seller_id = uid;
                        p.estimatedTime = time;
                        p.images = [];
                        p.quantity = quantity;
                        p.description = description;
                    }
                    console.log(p);
                    if (images.length > 0) {
                        let newImages = [];
                        let oldImages = [];
                        images.forEach((image) => {
                            if (typeof (image) == "object") {
                                newImages.push(image);
                            }
                            else {
                                oldImages.push(image);
                            }
                        });
                        if (newImages.length > 0) {
                            insertImage(p.id, newImages, function (urls) {
                                p.images = oldImages.concat(urls);
                                // console.log(p);
                                insertProduct(p, seller, false, productResult);
                            });
                        }
                        else {
                            p.images = oldImages;
                            insertProduct(p, seller, false, productResult);
                        }
                    }
                    else {
                        insertProduct(p, seller, false, productResult);
                    }
                });
            }
        }

        function productResult() {
            window.location.replace("products.html");
        }

        function getProduct(seller) {
            // console.log(seller.products);
            seller.products.forEach((p) => {
                if (p.id == id) {
                    product = p;
                }
            });
            if (product == null) {
                window.location.replace("products.html");
            }
            else {
                loadProductData();
            }
        }

        function loadProductData() {
            console.log(product);
            document.getElementById("title").innerHTML = "Edit Product";
            categories.value = product.category;
            subCategories.value = product.subcategory;
            nameInput.value = product.name;
            priceInput.value = product.price;
            descriptionInput.value = product.description;
            quanitityInput.value = product.quantity;
            timeInput.value = product.estimatedTime;
            images = product.images;
            if (images.length > 0) {
                updateCarousel();
            }
            addProductBtn.innerHTML = "Update Product";
            addProductBtn.setAttribute('onclick', "addProduct(false)");
            deleteProductBtn.style.display = "block";
        }

        function deleteP() {
            getUserDetails(false, function (seller) {
                deleteProduct(product.id, seller, (code) => {
                    if (code == codes.INSERTION_SUCCESS) {
                        window.location.replace("products.html");
                    }
                    else {
                        //TODO: deletion failure
                    }
                });
            });

        }
    </script>
</body>

</html>